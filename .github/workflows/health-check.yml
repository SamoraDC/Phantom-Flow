name: Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Check API Health
        id: health
        run: |
          response=$(curl -s -o response.json -w "%{http_code}" https://quantumflow-hft.fly.dev/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "API is healthy"
            cat response.json
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "API returned status: $response"
          fi

      - name: Check if Shabbat pause
        id: shabbat
        if: steps.health.outputs.status == 'healthy'
        run: |
          status=$(cat response.json | jq -r '.details.shabbat_pause // false')
          echo "shabbat_pause=$status" >> $GITHUB_OUTPUT
          echo "Shabbat pause: $status"

      - name: Restart if unhealthy
        if: steps.health.outputs.status == 'unhealthy'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "System unhealthy, attempting restart..."

          # Install flyctl
          curl -L https://fly.io/install.sh | sh
          export FLYCTL_INSTALL="/home/runner/.fly"
          export PATH="$FLYCTL_INSTALL/bin:$PATH"

          # Restart the app
          flyctl apps restart quantumflow-hft

      - name: Send alert on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="⚠️ QuantumFlow Health Check Failed\n\nThe system may be down. Automatic restart attempted."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML"
          fi
